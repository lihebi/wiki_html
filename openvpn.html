<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<link rel="Stylesheet" type="text/css" href="style.css"/>
		<link rel="shortcut icon" type="image/x-icon" href="img/favicon.ico"/>
		<title>openvpn</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
		<link rel="stylesheet" type="text/css" href="sh/styles/shCore.css"/>
		<link rel="stylesheet" type="text/css" href="sh/styles/shThemeDefault.css"/>
                <link rel="stylesheet" href="style/bootstrap.css"/>
		<script src="sh/scripts/shCore.js" type="text/javascript"></script>
		<script src="sh/scripts/shAutoloader.js" type="text/javascript"></script>
                <script src="js/jquery.min.js"></script>
                <script src="js/bootstrap.js"></script>
                <script src="js/lihebi.js"></script>
		<!--
		<script src="sh/scripts/shBrushCpp.js" type="text/javascript"></script>
		<script src="sh/scripts/shBrushJava.js" type="text/javascript"></script>
		<script src="sh/scripts/shBrushXml.js" type="text/javascript"></script>
		<script src="sh/scripts/shBrushPython.js" type="text/javascript"></script>
		-->
	</head>
	<body>
            <div class="container">
	        
<h1 id="toc_1">openvpn</h1>
<p>
<a href="index.html">首页</a>
<div class="toc">
<ul>
<li><a href="#toc_1">openvpn</a>
<ul>
<li><a href="#toc_1.1">easy-rsa</a>
<li><a href="#toc_1.2">files</a>
<li><a href="#toc_1.3">revoke user</a>
<li><a href="#toc_1.4">config</a>
<li><a href="#toc_1.5">~/client.conf</a>
<li><a href="#toc_1.6">start service</a>
<li><a href="#toc_1.7">forward config</a>
<li><a href="#toc_1.8">iptables</a>
<li><a href="#toc_1.9">dns</a>
<li><a href="#toc_1.10">use in mac</a>
<li><a href="#toc_1.11">use in windows</a>
</ul>
</ul>
</div>
</p>

<p>
For Debian7 &amp; ubuntu 12.04
</p>

<p>
<a href="https://library.linode.com/networking/openvpn/ubuntu-12.04-precise ">origin article</a>
</p>

<pre class="brush: shell">
apt-get update
apt-get upgrade
apt-get install openvpn
</pre>
<h2 id="toc_1.1">easy-rsa</h2>
<pre class="brush: shell">
cp -R /usr/share/doc/openvpn/examples/easy-rsa/ /etc/openvpn
cd /etc/openvpn/easy-rsa/2.0/
ln -s openssl-1.0.0.cnf openssl.cnf
. /etc/openvpn/easy-rsa/2.0/vars
. /etc/openvpn/easy-rsa/2.0/clean-all
. /etc/openvpn/easy-rsa/2.0/build-ca

. /etc/openvpn/easy-rsa/2.0/build-key-server server
. /etc/openvpn/easy-rsa/2.0/build-key client1 # one user a time
. /etc/openvpn/easy-rsa/2.0/build-dh
</pre>

<h2 id="toc_1.2">files</h2>
<p>
<code>ca.crt</code>
<code>client1.crt</code>
<code>client1.key</code>
</p>
<pre class="brush: shell">
cd /etc/openvpn/easy-rsa/2.0/keys
cp ca.crt ca.key dh1024.pem server.crt server.key /etc/openvpn
</pre>

<h2 id="toc_1.3">revoke user</h2>
<pre class="brush: shell">
. /etc/openvpn/easy-rsa/2.0/vars
. /etc/openvpn/easy-rsa/2.0/revoke-full client1
</pre>

<h2 id="toc_1.4">config</h2>
<pre class="brush: shell">
cd /usr/share/doc/openvpn/examples/sample-config-files
gunzip -d server.conf.gz
cp server.conf /etc/openvpn/
cp client.conf ~/
cd ~/
</pre>

<h2 id="toc_1.5">~/client.conf</h2>
<pre>
remote example.com 1194
ca ca.crt
cert client1.crt
key client1.key
</pre>

<h2 id="toc_1.6">start service</h2>
<p>
<code>service openvpn start</code>
</p>

<h2 id="toc_1.7">forward config</h2>
<p>
/etc/openvpn/server.conf:
<code>push "redirect-gateway def1 bypass-dhcp"</code>
</p>

<p>
/etc/sysctl.conf:
<code>net.ipv4.ip_forward=1</code>
</p>

<p>
<code>echo 1 &gt; /proc/sys/net/ipv4/ip_forward</code>
</p>

<h2 id="toc_1.8">iptables</h2>
<pre class="brush: shell">
iptables -A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -A FORWARD -s 10.8.0.0/24 -j ACCEPT
iptables -A FORWARD -j REJECT
iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE
iptables -A INPUT -i tun+ -j ACCEPT
iptables -A FORWARD -i tun+ -j ACCEPT
iptables -A INPUT -i tap+ -j ACCEPT
iptables -A FORWARD -i tap+ -j ACCEPT
</pre>

<p>
/etc/rc.local:
</p>
<pre>
iptables -A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -A FORWARD -s 10.8.0.0/24 -j ACCEPT
iptables -A FORWARD -j REJECT
iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE
iptables -A INPUT -i tun+ -j ACCEPT
iptables -A FORWARD -i tun+ -j ACCEPT
iptables -A INPUT -i tap+ -j ACCEPT
iptables -A FORWARD -i tap+ -j ACCEPT

exit 0
</pre>

<h2 id="toc_1.9">dns</h2>
<p>
<code>apt-get install dnsmasq resolvconf</code>
</p>

<p>
/etc/dnsmasq.conf:
</p>
<pre>
listen-address=127.0.0.1,10.8.0.1
bind-interfaces
</pre>

<p>
/etc/network/interfaces:
</p>
<pre>
auto eth0
iface eth0 inet dhcp

dns-search members.linode.com
dns-nameservers 97.107.133.4 207.192.69.4 207.192.69.5
</pre>

<p>
/etc/rc.local:
</p>
<pre>
/etc/init.d/dnsmasq restart
exit 0
</pre>

<p>
/etc/openvpn/server.conf:
</p>
<pre>
push "dhcp-option DNS 10.8.0.1"
</pre>

<p>
reboot
</p>

<h2 id="toc_1.10">use in mac</h2>
<p>
tunnelblick
</p>

<h2 id="toc_1.11">use in windows</h2>
<p>
use openvpn gui, stable version, installation package(both 32-bit and 64-bit TAP driver included)
openvpn-2.0.9-gui-1.0.3-install.exe
</p>

<ol>
<li>
in /etc/openvpn/server.conf, remove the bypass-dhcp in push directive

<li>
in client.ovpn, add <code>route-method exe</code> in the end

</ol>

            </div>
		<script type="text/javascript">
			function path()
			{
				var args = arguments, result = [];
				for (var i=0;i<args.length;i++)
					result.push(args[i].replace('@', './sh/scripts/'));
				return result;
			};
			SyntaxHighlighter.autoloader.apply(null, path(
				'applescript		@shBrushAppleScript.js',
				'actionscript3 as3	@shBrushAS3.js',
				'bash shell		@shBrushBash.js',
				'coldfusion cf		@shBrushColdFusion.js',
				'cpp c			@shBrushCpp.js',
				'c# c-sharp csharp	@shBrushCSharp.js',
				'css			@shBrushCss.js',
				'delphi pascal		@shBrushDelphi.js',
				'diff patch pas		@shBrushDiff.js',
				'erl erlang		@shBrushErlang.js',
				'groovy			@shBrushGroovy.js',
				'java			@shBrushJava.js',
				'jfx javafx		@shBrushJavaFX.js',
				'js jscript javascript	@shBrushJScript.js',
				'perl pl		@shBrushPerl.js',
				'php			@shBrushPhp.js',
				'text plain		@shBrushPlain.js',
				'py python		@shBrushPython.js',
				'ruby rails ror rb	@shBrushRuby.js',
				'sass scss		@shBrushSass.js',
				'scala			@shBrushScala.js',
				'sql			@shBrushSql.js',
				'vb vbnet		@shBrushVb.js',
				'xml xhtml xslt html	@shBrushXml.js'
			));
			SyntaxHighlighter.all();
		</script>
	</body>
</html>
